name: Uptime & Lighthouse Monitor

on:
  schedule:
    - cron: '*/30 * * * *' # every 30 minutes
  workflow_dispatch:

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    steps:
      - name: Print environment info
        run: |
          echo "Workflow: Lighthouse Monitor"
          echo "Trigger: ${{ github.event_name }}"
          echo "Timestamp: $(date -Iseconds)"
          echo "Runner: $(uname -a)"

      - name: Install Lighthouse CI
        run: |
          echo "Installing Lighthouse CI..."
          npm i -g @lhci/cli@0.13.x
          echo "Lighthouse CI version: $(lhci --version)"

      - name: Run Lighthouse CI (with retries)
        env:
          SITE_URL: ${{ secrets.SITE_URL }}
        run: |
          echo "=== Lighthouse Audit Starting ==="
          echo "Target: $SITE_URL"
          echo "Timestamp: $(date -Iseconds)"
          success=0
          for i in 1 2 3; do
            echo "--- Lighthouse attempt $i ---"
            if lhci autorun \
              --collect.url="$SITE_URL" \
              --collect.numberOfRuns=1 \
              --collect.settings.formFactor=desktop \
              --collect.settings.screenEmulation.disabled=true \
              --upload.target=temporary-public-storage; then
              echo "✅ Lighthouse attempt $i succeeded"
              success=1; break
            else
              echo "❌ LHCI attempt $i failed; retrying in 10s..."
              sleep 10
            fi
          done
          if [ "$success" -ne 1 ]; then
            echo "💥 LHCI failed after all retries" >&2
            exit 1
          fi
          echo "=== Lighthouse Audit Completed Successfully ==="

  uptime:
    runs-on: ubuntu-latest
    steps:
      - name: Print environment info
        run: |
          echo "Workflow: Uptime Monitor"
          echo "Trigger: ${{ github.event_name }}"
          echo "Timestamp: $(date -Iseconds)"
          echo "Runner: $(uname -a)"

      - name: Check uptime (with retries)
        env:
          SITE_URL: ${{ secrets.SITE_URL }}
        run: |
          echo "=== Uptime Check Starting ==="
          echo "Checking $SITE_URL"
          echo "Timestamp: $(date -Iseconds)"
          ok=0
          for i in 1 2 3 4 5; do
            echo "--- Uptime attempt $i ---"
            code=$(curl -s -o /dev/null -w "%{http_code}" -m 30 "$SITE_URL")
            echo "Attempt $i: HTTP $code ($(date -Iseconds))"
            if [ "$code" -ge 200 ] && [ "$code" -lt 400 ]; then
              echo "✅ Site is healthy (HTTP $code)"
              ok=1
              break
            else
              echo "⚠️ Site returned HTTP $code, waiting 10s..."
            fi
            sleep 10
          done
          if [ "$ok" -ne 1 ]; then
            echo "💥 Site down or unhealthy after all retries" >&2
            exit 1
          fi
          echo "=== Uptime Check Completed Successfully ==="

