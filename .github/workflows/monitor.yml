name: Uptime & Lighthouse Monitor

on:
  schedule:
    - cron: '*/30 * * * *' # every 30 minutes
  workflow_dispatch:

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    steps:
      - name: Install Lighthouse CI
        run: |
          npm i -g @lhci/cli@0.13.x
      - name: Run Lighthouse CI (with retries)
        env:
          SITE_URL: ${{ secrets.SITE_URL }}
        run: |
          echo "Target: $SITE_URL"
          success=0
          for i in 1 2 3; do
            if lhci autorun \
              --collect.url="$SITE_URL" \
              --collect.numberOfRuns=1 \
              --collect.settings.formFactor=desktop \
              --collect.settings.screenEmulation.disabled=true \
              --upload.target=temporary-public-storage; then
              success=1; break
            else
              echo "LHCI attempt $i failed; retrying in 10s..."
              sleep 10
            fi
          done
          if [ "$success" -ne 1 ]; then
            echo "LHCI failed after retries" >&2
            exit 1
          fi

  uptime:
    runs-on: ubuntu-latest
    steps:
      - name: Check uptime (with retries)
        env:
          SITE_URL: ${{ secrets.SITE_URL }}
        run: |
          echo "Checking $SITE_URL"
          ok=0
          for i in 1 2 3 4 5; do
            code=$(curl -s -o /dev/null -w "%{http_code}" "$SITE_URL")
            echo "Attempt $i: HTTP $code"
            if [ "$code" -ge 200 ] && [ "$code" -lt 400 ]; then
              ok=1
              break
            fi
            sleep 10
          done
          if [ "$ok" -ne 1 ]; then
            echo "Site down or unhealthy after retries" >&2
            exit 1
          fi

